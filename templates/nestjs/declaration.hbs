{{>comments}}

{{#compare node "===" "ModelDeclaration"}}
export type {{>expression id suffix=./suffix prefix=./prefix}} = {{>expression definition}}
{{/compare}}

{{~#compare node "===" "PropertyDeclaration"}}
{{>expression id}}{{^required}}?{{/required}}: {{>expression definition enum=./enum}};
{{/compare~}}

{{#*inline "validator"}}
{{~#compare validation "!==" false}}
{{#compare node "===" "ReferenceExpression"}}
    new {{prefix}}ValidationPipe({{& resolveValidator .}})
{{else}}
    {{log "Only references are support for validation currently" level="warn"}}
{{/compare}}
{{/compare~}}
{{/inline}}

{{#*inline "callValidator"}}
{{~#compare validation "!==" false}}
{{#compare node "===" "ResponseExpression"}}
    {{log .}}
    if(response.status === {{toInt statusCode}}) {
        const responseValidator = new {{prefix}}ValidationPipe({{& resolveValidator .}});
        responseValidator.transform(response, { type: 'custom' });
        }
{{/compare}}
{{/compare~}}
{{/inline}}

{{~#compare node "===" "OperationDeclaration"}}
protected abstract {{>expression id prefix="_"}}(
    {{~#if requests.bodies~}}
    body:{{#requests.bodies}}{{> expression}},{{/requests.bodies}}
    {{~/if~}}    
    {{~#if requests.pathParameters~}}
    path:{{#requests.pathParameters}}{{> expression}},{{/requests.pathParameters}}
    {{~/if~}}
    {{~#if requests.queryParameters~}}
    query:{{#requests.queryParameters}}{{> expression}},{{/requests.queryParameters}}
    {{~/if~}}
    {{~#if requests.headerParameters~}}
    headers:{{#requests.headerParameters}}{{> expression}},{{/requests.headerParameters}}
    {{~/if~}}
): Promise<{{prefix}}ControllerResponse<
    {{^isEmpty responses}}
    {{#forEach responses}}
    {{>expression .}} {{#unless isLast}}|{{/unless}}
    {{/forEach}},
    {{#forEach responses}}
    {{>expression this.headers}} {{#unless isLast}}|{{/unless}}
    {{/forEach}}    
    {{else}}
    void
    {{/isEmpty}}    
    >>;
@{{& httpMethod}}('{{replace path (toRegex "{(\w+)}" "g") ":$1"}}')
async {{>expression id}}(
    {{#if requests.bodies}}    
    @Body({{#requests.bodies}}{{>validator . prefix=../prefix validation=../extensions.x-validation}}{{/requests.bodies}}) body:{{#requests.bodies}}{{> expression}},{{/requests.bodies}}
    {{/if}}
    {{#if requests.pathParameters}}
    @Param({{>validator requests.pathParameters prefix=prefix validation=../extensions.x-validation}}) path:{{#requests.pathParameters}}{{> expression}},{{/requests.pathParameters}}
    {{/if}}    
    {{#if requests.queryParameters}}
    @Query({{>validator requests.queryParameters prefix=prefix validation=../extensions.x-validation}}) query:{{#requests.queryParameters}}{{> expression}},{{/requests.queryParameters}}
    {{/if}}
    {{#if requests.headerParameters}}
    @Headers({{>validator requests.headerParameters prefix=prefix validation=../extensions.x-validation}}) headers:{{#requests.headerParameters}}{{> expression}},{{/requests.headerParameters}}
    {{/if}}
): Promise<{{prefix}}ControllerResponse<
    {{^isEmpty responses}}
    {{#forEach responses}}
    {{>expression .}} {{#unless isLast}}|{{/unless}}
    {{/forEach}},
    {{#forEach responses}}
    {{>expression this.headers}} {{#unless isLast}}|{{/unless}}
    {{/forEach}}
    {{else}}
    void
    {{/isEmpty}}
    >> {
    const response = await this.{{>expression id prefix="_"}}(
        {{#if requests.bodies}}body,{{/if}}
        {{#if requests.pathParameters}}path,{{/if}}
        {{#if requests.queryParameters}}query,{{/if}}
        {{#if requests.headerParameters}}headers,{{/if}}
    );
    {{!-- 
    {{^isEmpty responses}}
    {{#forEach responses}}
    {{>callValidator . prefix=../prefix validation=../extensions.x-validation}}
    {{/forEach}}
    {{/isEmpty}}
    --}}
    return response;
}

{{#if requests.cookieParameters}}{{log "Cookie parameters not supported yet" level="warn"}}{{/if}}
{{/compare}}